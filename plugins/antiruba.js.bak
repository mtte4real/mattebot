import fs from 'fs';

// Owner del bot (formato JID)
const owners = [
  '393715983481@s.whatsapp.net',
  '393884769557@s.whatsapp.net'
];
const adminsPath = './config/admins.json';

let modalitaSicurezzaAttiva = {};

async function attivaSicurezza(conn, chat, promotore, promosso, m) {
  const metadata = await conn.groupMetadata(chat);
  const participants = metadata.participants;

  const adminList = participants
    .filter(p => p.admin && !owners.includes(p.id) && p.id !== conn.user.jid)
    .map(p => p.id);

  const promotoreTag = '@' + promotore.split('@')[0];
  const promossoTag = '@' + promosso.split('@')[0];
  const ownersTag = owners.map(o => '@' + o.split('@')[0]).join(' ');

  const messaggioAllarme = `ðŸš¨ *ALLARME SICUREZZA ATTIVATO* ðŸš¨

âš ï¸ *Admin che ha promosso:* ${promotoreTag}
ðŸ‘¤ *Utente promosso:* ${promossoTag}

Motivo: Rilevata promozione ad admin da parte di un non-owner (${promotore})

ðŸ›¡ï¸ *Attivazione protezione in corso...* ðŸ›¡ï¸

ðŸ‘‘ *Attenzione Owner:*
${ownersTag}`;

  await conn.sendMessage(chat, {
    text: messaggioAllarme,
    mentions: [promotore, promosso, ...owners]
  });

  for (const admin of adminList) {
    await conn.groupParticipantsUpdate(chat, [admin], 'demote');
  }

  fs.writeFileSync(adminsPath, JSON.stringify(adminList, null, 2));
  await conn.groupSettingUpdate(chat, 'announcement');

  const messaggioAttivata = `ðŸ›¡ï¸ *MODALITÃ€ SICUREZZA ATTIVATA* ðŸ›¡ï¸

âœ… Rimossi ${adminList.length} amministratori dal gruppo.
âœ… Gruppo chiuso: solo gli admin possono inviare messaggi.

ðŸ‘‘ Solo gli owner del bot, l'owner del gruppo e il bot stesso mantengono i privilegi di amministrazione.

âš ï¸ Tutti i comandi del bot sono ora disponibili solo per gli owner.
Un owner puÃ² eseguire !safe per disattivare la modalitÃ  sicurezza quando la situazione sarÃ  risolta.

ðŸ‘‘ *Owner del bot:* ${ownersTag}`;

  await conn.sendMessage(chat, {
    text: messaggioAttivata,
    mentions: owners
  });

  modalitaSicurezzaAttiva[chat] = true;
}

async function disattivaSicurezza(conn, chat, m) {
  if (!modalitaSicurezzaAttiva[chat]) return m.reply('âŒ La modalitÃ  sicurezza non Ã¨ attiva.');

  const adminList = JSON.parse(fs.readFileSync(adminsPath));

  for (const admin of adminList) {
    await conn.groupParticipantsUpdate(chat, [admin], 'promote');
  }

  await conn.groupSettingUpdate(chat, 'not_announcement');

  await conn.sendMessage(chat, {
    text: `ðŸ›¡ï¸ *Disattivazione modalitÃ  sicurezza in corso...* ðŸ›¡ï¸`
  });

  await conn.sendMessage(chat, {
    text: `âœ… *ModalitÃ  sicurezza disattivata* âœ…

Ripristinati ${adminList.length} amministratori nel gruppo da config/admins.json.
Gruppo riaperto: tutti possono inviare messaggi.

Il gruppo Ã¨ ora tornato alla normalitÃ .`
  });

  modalitaSicurezzaAttiva[chat] = false;
}

let handler = async (m, { conn }) => {
  const chat = m.chat;

  if (m.body && m.body.trim() === '!safe' && owners.includes(m.sender)) {
    return await disattivaSicurezza(conn, chat, m);
  }

  if (m.messageStubType === 29 && m.messageStubParameters?.length >= 2) {
    const promosso = m.messageStubParameters[0];
    const promotore = m.messageStubParameters[1];

    if (!owners.includes(promotore)) {
      await attivaSicurezza(conn, chat, promotore, promosso, m);
    }
  }
};

handler.group = true;
handler.listen = true;

export default handler;